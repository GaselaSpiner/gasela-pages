<!-- 🔑 Logika rejestracji -->
<script>
  const supabaseUrl = 'https://lmussgaiutaldicolyba.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
  const statusDiv = document.getElementById('supabase-status');
  const form = document.getElementById('register-form');

  async function checkIfUserExists(email) {
    const { data, error } = await supabase.auth.admin.listUsers({ email });
    return data?.users?.length > 0;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusDiv.textContent = '⏳ Sprawdzanie adresu e-mail...';

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (password.length < 6) {
      statusDiv.textContent = '❌ Hasło musi mieć co najmniej 6 znaków.';
      return;
    }

    const exists = await checkIfUserExists(email);
    if (exists) {
      statusDiv.textContent = '❌ Użytkownik z tym adresem już istnieje. Przejdź do logowania.';
      return;
    }

    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: 'https://app.gaselaspiner.pl/potwierdzenie.html'
        }
      });

      if (error) {
        console.error('❌ Błąd rejestracji:', error.message);
        statusDiv.textContent = '❌ Nie udało się założyć konta';
      } else {
        console.log('✅ Rejestracja zakończona:', data);

        await zapiszPlanDoPending(email);

        statusDiv.innerHTML = `
          <div style="color:green; font-weight:bold; text-align:center;">
            ✅ Rejestracja zakończona.<br>
            📩 Sprawdź swoją skrzynkę e-mail i kliknij link potwierdzający, aby aktywować konto.<br>
            ⏳ Nastąpi przekierowanie do logowania za 10 sekund...
          </div>
        `;

        form.reset();
        form.style.display = 'none';

        const loginLinkDiv = document.querySelector('.login-link');
        if (loginLinkDiv) loginLinkDiv.remove();

        if (!document.getElementById('go-to-login-btn')) {
          const loginBtn = document.createElement('button');
          loginBtn.id = 'go-to-login-btn';
          loginBtn.textContent = 'Przejdź do logowania';
          loginBtn.style.marginTop = '20px';
          loginBtn.onclick = () => {
            window.location.href = 'logowanie.html';
          };
          document.body.appendChild(loginBtn);
        }

        setTimeout(() => {
          window.location.href = 'logowanie.html';
        }, 10000);
      }
    } catch (err) {
      console.error('❌ Wyjątek:', err);
      statusDiv.textContent = '❌ Błąd wewnętrzny: ' + err.message;
    }
  });
</script>
