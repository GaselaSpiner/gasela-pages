<!-- ğŸ”‘ Logika rejestracji -->
<script>
  const supabaseUrl = 'https://lmussgaiutaldicolyba.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
  const statusDiv = document.getElementById('supabase-status');
  const form = document.getElementById('register-form');

  async function checkIfUserExists(email) {
    const { data, error } = await supabase.auth.admin.listUsers({ email });
    return data?.users?.length > 0;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusDiv.textContent = 'â³ Sprawdzanie adresu e-mail...';

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (password.length < 6) {
      statusDiv.textContent = 'âŒ HasÅ‚o musi mieÄ‡ co najmniej 6 znakÃ³w.';
      return;
    }

    const exists = await checkIfUserExists(email);
    if (exists) {
      statusDiv.textContent = 'âŒ UÅ¼ytkownik z tym adresem juÅ¼ istnieje. PrzejdÅº do logowania.';
      return;
    }

    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: 'https://app.gaselaspiner.pl/potwierdzenie.html'
        }
      });

      if (error) {
        console.error('âŒ BÅ‚Ä…d rejestracji:', error.message);
        statusDiv.textContent = 'âŒ Nie udaÅ‚o siÄ™ zaÅ‚oÅ¼yÄ‡ konta';
      } else {
        console.log('âœ… Rejestracja zakoÅ„czona:', data);

        await zapiszPlanDoPending(email);

        statusDiv.innerHTML = `
          <div style="color:green; font-weight:bold; text-align:center;">
            âœ… Rejestracja zakoÅ„czona.<br>
            ğŸ“© SprawdÅº swojÄ… skrzynkÄ™ e-mail i kliknij link potwierdzajÄ…cy, aby aktywowaÄ‡ konto.<br>
            â³ NastÄ…pi przekierowanie do logowania za 10 sekund...
          </div>
        `;

        form.reset();
        form.style.display = 'none';

        const loginLinkDiv = document.querySelector('.login-link');
        if (loginLinkDiv) loginLinkDiv.remove();

        if (!document.getElementById('go-to-login-btn')) {
          const loginBtn = document.createElement('button');
          loginBtn.id = 'go-to-login-btn';
          loginBtn.textContent = 'PrzejdÅº do logowania';
          loginBtn.style.marginTop = '20px';
          loginBtn.onclick = () => {
            window.location.href = 'logowanie.html';
          };
          document.body.appendChild(loginBtn);
        }

        setTimeout(() => {
          window.location.href = 'logowanie.html';
        }, 10000);
      }
    } catch (err) {
      console.error('âŒ WyjÄ…tek:', err);
      statusDiv.textContent = 'âŒ BÅ‚Ä…d wewnÄ™trzny: ' + err.message;
    }
  });
</script>
