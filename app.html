<script>
  async function checkSessionAndPlan() {
    const session = (await supabase.auth.getSession()).data.session;
    if (!session) return;

    const jwt = session.access_token;
    const userId = session.user.id;
    welcome.textContent = `Witaj, ${session.user.email || 'Zawodniku'}!`;

    // üîç Sprawd≈∫, czy u≈ºytkownik ma ju≈º aktywny plan
    const { data: subData, error: subError } = await supabase
      .from('subscriptions')
      .select('plan_name, end_date')
      .eq('user_id', userId)
      .order('end_date', { ascending: false })
      .limit(1)
      .maybeSingle();

    const planActive = subData && new Date(subData.end_date) > new Date();

    // üîç Sprawd≈∫, czy istnieje wpis w pending_plans
    const { data: pending, error: pendError } = await supabase
      .from('pending_plans')
      .select('plan_name')
      .eq('user_id', userId)
      .maybeSingle();

    // ‚úÖ Je≈õli brak aktywnego planu i istnieje wpis w pending_plans ‚Üí aktywuj
    if (!planActive && pending) {
      await fetch('https://lmussgaiutaldicolyba.supabase.co/functions/v1/aktywuj_plan', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${jwt}`
        }
      });
    }

    // üì• Ponowne pobranie danych po ewentualnej aktywacji
    const { data: subNow, error: subErrorNow } = await supabase
      .from('subscriptions')
      .select('plan_name, end_date')
      .eq('user_id', userId)
      .order('end_date', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (subErrorNow || !subNow) {
      statusMsg.textContent = '‚ùå Nie znaleziono aktywnego planu.';
      return;
    }

    const { data: limitData, error: limitError } = await supabase
      .from('message_limits')
      .select('total_limit, used_messages')
      .eq('user_id', userId)
      .single();

    if (limitError || !limitData) {
      statusMsg.textContent = '‚ùå Nie znaleziono limit√≥w wiadomo≈õci.';
      return;
    }

    const remaining = limitData.total_limit - limitData.used_messages;
    const endDate = subNow.end_date ? new Date(subNow.end_date).toISOString().split('T')[0] : 'brak daty';
    statusMsg.textContent = `‚úÖ Plan aktywny do ${endDate}.\n\nüî• Masz jeszcze ${remaining} wiadomo≈õci do wykorzystania ‚Äì powodzenia!`;

    chatUI.style.display = 'block';
    const plan = subNow.plan_name;
    window.maxInputLength = plan === 'pro' ? 800 : plan === 'mistrz' ? 1000 : 600;
    userInput.setAttribute("maxlength", window.maxInputLength);

    await fetchPrompts(jwt);
  }
</script>
