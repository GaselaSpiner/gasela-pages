<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gasela Spiner ‚Äì Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    #chatUI {
      display: none;
      margin-top: 20px;
    }
    #aiOutput {
      white-space: pre-wrap;
      margin-top: 10px;
    }
    #buyPlanBtn {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 15px;
      background-color: #ffcc00;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #buyPlanBtn:hover {
      background-color: #ffaa00;
    }
  </style>
</head>
<body>
  <h1 id="welcome">Witaj!</h1>
  <p id="statusMsg">‚è≥ ≈Åadowanie planu...</p>

  <div id="chatUI">
    <textarea id="userInput" rows="3" placeholder="Wpisz wiadomo≈õƒá..." maxlength="600"></textarea><br>
    <button onclick="handleChat()">Wy≈õlij</button>
    <pre id="aiOutput"></pre>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://lmussgaiutaldicolyba.supabase.co',
      'public-anon-key' // lub zamie≈Ñ na process.env je≈õli zabezpieczone
    );

    async function checkSessionAndPlan() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;

      const jwt = session.access_token;
      const userId = session.user.id;
      welcome.textContent = `Witaj, ${session.user.email || 'Zawodniku'}!`;

      const { data: subData } = await supabase
        .from('subscriptions')
        .select('plan_name, end_date')
        .eq('user_id', userId)
        .order('end_date', { ascending: false })
        .limit(1)
        .maybeSingle();

      const planActive = subData && new Date(subData.end_date) > new Date();

      const { data: pending } = await supabase
        .from('pending_plans')
        .select('plan_name')
        .eq('user_id', userId)
        .maybeSingle();

      if (!planActive && pending) {
        await fetch('https://lmussgaiutaldicolyba.supabase.co/functions/v1/aktywuj_plan', {
          method: 'POST',
          headers: { Authorization: `Bearer ${jwt}` }
        });
      }

      const { data: subNow, error: subErrorNow } = await supabase
        .from('subscriptions')
        .select('plan_name, end_date')
        .eq('user_id', userId)
        .order('end_date', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (subErrorNow || !subNow) {
        statusMsg.textContent = '‚ùå Nie znaleziono aktywnego planu.';
        return;
      }

      const { data: limitData, error: limitError } = await supabase
        .from('message_limits')
        .select('total_limit, used_messages')
        .eq('user_id', userId)
        .single();

      if (limitError || !limitData) {
        statusMsg.textContent = '‚ùå Nie znaleziono limit√≥w wiadomo≈õci.';
        return;
      }

      const remaining = limitData.total_limit - limitData.used_messages;
      const endDate = subNow.end_date ? new Date(subNow.end_date).toISOString().split('T')[0] : 'brak daty';
      statusMsg.textContent = `‚úÖ Plan aktywny do ${endDate}.\n\nüî• Masz jeszcze ${remaining} wiadomo≈õci do wykorzystania ‚Äì powodzenia!`;

      chatUI.style.display = 'block';
      const plan = subNow.plan_name;
      window.maxInputLength = plan === 'pro' ? 800 : plan === 'mistrz' ? 1000 : 600;
      userInput.setAttribute("maxlength", window.maxInputLength);

      await fetchPrompts(jwt);
    }

    async function handleChat() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return;
      const jwt = session.access_token;

      const verifyResponse = await fetch('https://lmussgaiutaldicolyba.supabase.co/functions/v1/verify_and_increment', {
        method: 'POST',
        headers: { Authorization: `Bearer ${jwt}` }
      });

      if (verifyResponse.status === 403) {
        aiOutput.innerHTML = `
          ‚ùå Nie mo≈ºesz wys≈Çaƒá wiadomo≈õci: Limit wiadomo≈õci zosta≈Ç wyczerpany.
          <br><br>
          <button id="buyPlanBtn">Kup nowy plan</button>
        `;
        document.getElementById("buyPlanBtn").onclick = () => {
          window.location.href = "kup-plan.html";
        };
        return;
      }

      const input = userInput.value.trim();
      if (!input) return;

      const askResponse = await fetch('https://lmussgaiutaldicolyba.supabase.co/functions/v1/ask_openai', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${jwt}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ user_input: input })
      });

      const result = await askResponse.json();
      aiOutput.textContent = result.output || '‚ö†Ô∏è Brak odpowiedzi AI.';
    }

    async function fetchPrompts(jwt) {
      await fetch('https://lmussgaiutaldicolyba.supabase.co/functions/v1/get_prompts_by_plan', {
        method: 'POST',
        headers: { Authorization: `Bearer ${jwt}` }
      });
    }

    checkSessionAndPlan();
  </script>
</body>
</html>
